rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profiles. Only the authenticated user can read and write their own profile.
     * @path /users/{userId}
     * @allow (create, update, delete) User with matching {userId} in path and auth.uid can modify their own profile.
     * @deny (create, update, delete) User attempting to modify a profile with a mismatched {userId}.
     * @principle Enforces document ownership for writes; restricts access to a user's own data tree.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      // Allow the user to read their own profile.
      allow get: if isOwner(userId);
      // Prevent listing of all users.
      allow list: if false;

      // Only allow creation if the user is creating their own profile.
      allow create: if isSignedIn() && isOwner(userId);

      // Only allow updates if the user is updating their own profile.
      allow update: if isSignedIn() && isExistingOwner(userId);

      // Only allow deletion if the user is deleting their own profile.
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Manages pet profiles for a specific user. Only the owner can manage their pets.
     * @path /users/{userId}/pets/{petId}
     * @allow (create, update, delete) Owner can create/modify pet profiles under their user ID.
     * @deny (create, update, delete) Non-owners attempting to manage pet profiles.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/pets/{petId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      // Allow the owner to read their pet profiles.
      allow get: if isOwner(userId);
      // Allow the owner to list their pet profiles.
      allow list: if isOwner(userId);

      // Only allow creation if the user is the owner.
      allow create: if isSignedIn() && isOwner(userId);

      // Only allow updates if the user is the owner and the document exists.
      allow update: if isSignedIn() && isExistingOwner(userId);

      // Only allow deletes if the user is the owner and the document exists.
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Manages meal plans for a pet. Only the owner of the pet can manage meal plans.
     * @path /users/{userId}/pets/{petId}/mealPlans/{mealPlanId}
     * @allow (create, update, delete) Owner can manage meal plans for their pets.
     * @deny (create, update, delete) Non-owners attempting to manage meal plans.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/pets/{petId}/mealPlans/{mealPlanId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      // Allow the owner to read their pet's meal plans.
      allow get: if isOwner(userId);
      // Allow the owner to list their pet's meal plans.
      allow list: if isOwner(userId);

      // Only allow creation if the user is the owner.
      allow create: if isSignedIn() && isOwner(userId);

      // Only allow updates if the user is the owner and the document exists.
      allow update: if isSignedIn() && isExistingOwner(userId);

      // Only allow deletes if the user is the owner and the document exists.
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Manages supplement recommendations for a pet. Only the owner of the pet can manage recommendations.
     * @path /users/{userId}/pets/{petId}/supplementRecommendations/{supplementRecommendationId}
     * @allow (create, update, delete) Owner can manage supplement recommendations for their pets.
     * @deny (create, update, delete) Non-owners attempting to manage supplement recommendations.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/pets/{petId}/supplementRecommendations/{supplementRecommendationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      // Allow the owner to read their pet's supplement recommendations.
      allow get: if isOwner(userId);
      // Allow the owner to list their pet's supplement recommendations.
      allow list: if isOwner(userId);

      // Only allow creation if the user is the owner.
      allow create: if isSignedIn() && isOwner(userId);

      // Only allow updates if the user is the owner and the document exists.
      allow update: if isSignedIn() && isExistingOwner(userId);

      // Only allow deletes if the user is the owner and the document exists.
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Manages activity records for a pet. Only the owner of the pet can manage activity records.
     * @path /users/{userId}/pets/{petId}/activityRecords/{activityRecordId}
     * @allow (create, update, delete) Owner can manage activity records for their pets.
     * @deny (create, update, delete) Non-owners attempting to manage activity records.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/pets/{petId}/activityRecords/{activityRecordId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      // Allow the owner to read their pet's activity records.
      allow get: if isOwner(userId);
      // Allow the owner to list their pet's activity records.
      allow list: if isOwner(userId);

      // Only allow creation if the user is the owner.
      allow create: if isSignedIn() && isOwner(userId);

      // Only allow updates if the user is the owner and the document exists.
      allow update: if isSignedIn() && isExistingOwner(userId);

      // Only allow deletes if the user is the owner and the document exists.
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }
  }
}