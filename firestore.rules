/**
 * @fileoverview Firestore Security Rules for the PetLife application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data. Each user can only
 * access their own data and the data of their pets. Data is organized hierarchically
 * under the `/users/{userId}` path to simplify ownership checks.
 *
 * Data Structure:
 * All data is nested under `/users/{userId}`, ensuring clear ownership.
 * - /users/{userId}: Stores user profiles.
 * - /users/{userId}/pets/{petId}: Stores pet profiles owned by a specific user.
 * - /users/{userId}/pets/{petId}/mealPlans/{mealPlanId}: Stores meal plans for a specific pet.
 * - /users/{userId}/pets/{petId}/supplementRecommendations/{supplementRecommendationId}: Stores supplement recommendations for a specific pet.
 * - /users/{userId}/pets/{petId}/activityRecords/{activityRecordId}: Stores activity records for a specific pet.
 *
 * Key Security Decisions:
 * - Users can only read and write their own user document.
 * - Users can only manage pets, meal plans, supplement recommendations, and activity records
 *   associated with their own user ID.
 * - No public listing of users or pets is allowed. Only owners can list their own resources.
 *
 * Denormalization for Authorization:
 *  - The data model includes a `userId` field on `Pet` documents and a `petId` field on
 *    `MealPlan`, `SupplementRecommendation`, and `ActivityRecord` documents. This denormalization
 *    allows for efficient security rules that do not require additional `get()` calls.
 * Structural Segregation:
 * All private user data is stored under the /users/{userId} path, ensuring that it is
 * isolated from other users and the public.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data. Only the user themselves can read/write their profile.
     * @path /users/{userId}
     * @allow (get, update, delete) User with ID 'lHwjFouEjMgD9hgraRBcx320eB03' can access /users/lHwjFouEjMgD9hgraRBcx320eB03.
     * @allow (create) User with ID 'lHwjFouEjMgD9hgraRBcx320eB03' can create /users/lHwjFouEjMgD9hgraRBcx320eB03
     * @deny (get, update, delete) User with ID 'otherUserId' cannot access /users/lHwjFouEjMgD9hgraRBcx320eB03.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to pet profiles. Only the owner of the user profile can manage their pets.
     * @path /users/{userId}/pets/{petId}
     * @allow (create, get, list, update, delete) User with ID 'lHwjFouEjMgD9hgraRBcx320eB03' can manage pets under /users/lHwjFouEjMgD9hgraRBcx320eB03.
     * @deny (create, get, list, update, delete) User with ID 'otherUserId' cannot manage pets under /users/lHwjFouEjMgD9hgraRBcx320eB03.
     * @principle Enforces document ownership for pet profiles.
     */
    match /users/{userId}/pets/{petId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to meal plans. Only the owner of the pet profile can manage meal plans.
     * @path /users/{userId}/pets/{petId}/mealPlans/{mealPlanId}
     * @allow (create, get, list, update, delete) User with ID 'lHwjFouEjMgD9hgraRBcx320eB03' can manage meal plans under /users/lHwjFouEjMgD9hgraRBcx320eB03/pets/{petId}.
     * @deny (create, get, list, update, delete) User with ID 'otherUserId' cannot manage meal plans under /users/lHwjFouEjMgD9hgraRBcx320eB03/pets/{petId}.
     * @principle Enforces document ownership for meal plans.
     */
    match /users/{userId}/pets/{petId}/mealPlans/{mealPlanId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to supplement recommendations. Only the owner of the pet profile can manage supplement recommendations.
     * @path /users/{userId}/pets/{petId}/supplementRecommendations/{supplementRecommendationId}
     * @allow (create, get, list, update, delete) User with ID 'lHwjFouEjMgD9hgraRBcx320eB03' can manage supplement recommendations under /users/lHwjFouEjMgD9hgraRBcx320eB03/pets/{petId}.
     * @deny (create, get, list, update, delete) User with ID 'otherUserId' cannot manage supplement recommendations under /users/lHwjFouEjMgD9hgraRBcx320eB03/pets/{petId}.
     * @principle Enforces document ownership for supplement recommendations.
     */
    match /users/{userId}/pets/{petId}/supplementRecommendations/{supplementRecommendationId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to activity records. Only the owner of the pet profile can manage activity records.
     * @path /users/{userId}/pets/{petId}/activityRecords/{activityRecordId}
     * @allow (create, get, list, update, delete) User with ID 'lHwjFouEjMgD9hgraRBcx320eB03' can manage activity records under /users/lHwjFouEjMgD9hgraRBcx320eB03/pets/{petId}.
     * @deny (create, get, list, update, delete) User with ID 'otherUserId' cannot manage activity records under /users/lHwjFouEjMgD9hgraRBcx320eB03/pets/{petId}.
     * @principle Enforces document ownership for activity records.
     */
    match /users/{userId}/pets/{petId}/activityRecords/{activityRecordId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}