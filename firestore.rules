/**
 * @fileoverview Firestore Security Rules for PetLife application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data. Each user can only
 * access their own data and the data of their pets.
 *
 * Data Structure:
 * The data is structured hierarchically under /users/{userId}, with pets, meal plans,
 * supplement recommendations, and activity records stored as subcollections. This structure
 * enables simple, path-based authorization.
 *
 * Key Security Decisions:
 * - All data is private and requires authentication.
 * - Users can only access their own data.
 * - No public listing of users or pets is allowed.
 *
 * Denormalization for Authorization:
 * The rules leverage the hierarchical data model to avoid the need for `get()` calls
 * and ensure atomic operations. Each document is secured based on its location within
 * the /users/{userId} path, which implicitly establishes ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles. Only the user themselves can read and write their profile.
     * @path /users/{userId}
     * @allow (create) - Authenticated user with ID matching the path can create their profile.
     * @allow (get, list, update, delete) - Authenticated user with ID matching the path can read, update, and delete their profile.
     * @deny (create) - Authenticated user with ID not matching the path cannot create a profile.
     * @deny (update, delete) - Authenticated user with ID not matching the path cannot update or delete a profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to pet profiles. Only the owner of the pet (user) can read and write pet profiles.
     * @path /users/{userId}/pets/{petId}
     * @allow (create) - Authenticated user who is the owner can create a pet profile.
     * @allow (get, list, update, delete) - Authenticated user who is the owner can read, update, and delete pet profiles.
     * @deny (create) - Authenticated user who is not the owner cannot create a pet profile.
     * @deny (update, delete) - Authenticated user who is not the owner cannot update or delete a pet profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/pets/{petId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

       function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }


      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to meal plans. Only the owner of the pet (user) can read and write meal plans.
     * @path /users/{userId}/pets/{petId}/mealPlans/{mealPlanId}
     * @allow (create) - Authenticated user who is the pet owner can create a meal plan.
     * @allow (get, list, update, delete) - Authenticated user who is the pet owner can read, update, and delete meal plans.
     * @deny (create) - Authenticated user who is not the pet owner cannot create a meal plan.
     * @deny (update, delete) - Authenticated user who is not the pet owner cannot update or delete a meal plan.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/pets/{petId}/mealPlans/{mealPlanId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/pets/$(petId)).data.userId == userId && request.resource.data.petId == petId;
      allow update: if isExistingOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/pets/$(petId)).data.userId == userId && request.resource.data.petId == petId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to supplement recommendations. Only the owner of the pet (user) can read and write supplement recommendations.
     * @path /users/{userId}/pets/{petId}/supplementRecommendations/{supplementRecommendationId}
     * @allow (create) - Authenticated user who is the pet owner can create a supplement recommendation.
     * @allow (get, list, update, delete) - Authenticated user who is the pet owner can read, update, and delete supplement recommendations.
     * @deny (create) - Authenticated user who is not the pet owner cannot create a supplement recommendation.
     * @deny (update, delete) - Authenticated user who is not the pet owner cannot update or delete a supplement recommendation.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/pets/{petId}/supplementRecommendations/{supplementRecommendationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }


      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/pets/$(petId)).data.userId == userId && request.resource.data.petId == petId;
      allow update: if isExistingOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/pets/$(petId)).data.userId == userId && request.resource.data.petId == petId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to activity records. Only the owner of the pet (user) can read and write activity records.
     * @path /users/{userId}/pets/{petId}/activityRecords/{activityRecordId}
     * @allow (create) - Authenticated user who is the pet owner can create an activity record.
     * @allow (get, list, update, delete) - Authenticated user who is the pet owner can read, update, and delete activity records.
     * @deny (create) - Authenticated user who is not the pet owner cannot create an activity record.
     * @deny (update, delete) - Authenticated user who is not the pet owner cannot update or delete an activity record.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/pets/{petId}/activityRecords/{activityRecordId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/pets/$(petId)).data.userId == userId && request.resource.data.petId == petId;
      allow update: if isExistingOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/pets/$(petId)).data.userId == userId && request.resource.data.petId == petId;
      allow delete: if isExistingOwner(userId);
    }
  }
}