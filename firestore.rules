/**
 * @fileoverview Firestore Security Rules for PetLife application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data. Each user can only
 * access their own data and the data of their pets. Data is organized hierarchically
 * under the /users/{userId} path to simplify authorization.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, with pets, meal plans, supplement recommendations,
 * and activity records as subcollections. This structure ensures clear ownership and avoids
 * the need for complex queries in security rules.
 *
 * Key Security Decisions:
 * - Users can only read and write their own user document.
 * - Users can only manage pets, meal plans, supplement recommendations, and activity records
 *   associated with their user ID.
 * - Listing of users is disallowed.
 *
 * Denormalization for Authorization:
 *  - The `userId` is present both in the path and as a field in the `Pet` document.
 *  - The `petId` is present both in the path and as a field in the `MealPlan`, `SupplementRecommendation` and `ActivityRecord` documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles.
     * @path /users/{userId}
     * @allow (create) - A user can create their own profile if the userId matches their auth.uid.
     * @allow (get, update, delete) - A user can only access their own profile data.
     * @deny (list) - Listing all users is not allowed.
     * @deny (create) - A user cannot create a user document with an ID that doesn't match their auth.uid.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      // isOwner function check if the user id is the same as the authenticated user id
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // isExistingOwner checks if the user is the owner and the resource exists
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to pet profiles.
     * @path /users/{userId}/pets/{petId}
     * @allow (create) - A user can create a pet profile under their userId.
     * @allow (get, list, update, delete) - A user can only access pet profiles associated with their user ID.
     * @deny (create) - A user cannot create a pet profile under another user's ID.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/pets/{petId} {
      // isOwner function check if the user id is the same as the authenticated user id
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // isExistingOwner checks if the user is the owner and the resource exists
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) ;
      allow update: if isExistingOwner(userId) ;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to meal plans for pets.
     * @path /users/{userId}/pets/{petId}/mealPlans/{mealPlanId}
     * @allow (create) - A user can create a meal plan for a pet they own.
     * @allow (get, list, update, delete) - A user can only access meal plans associated with their pet.
     * @deny (create) - A user cannot create a meal plan for a pet owned by another user.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/pets/{petId}/mealPlans/{mealPlanId} {
      // isOwner function check if the user id is the same as the authenticated user id
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // isExistingOwner checks if the user is the owner and the resource exists
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to supplement recommendations for pets.
     * @path /users/{userId}/pets/{petId}/supplementRecommendations/{supplementRecommendationId}
     * @allow (create) - A user can create a supplement recommendation for a pet they own.
     * @allow (get, list, update, delete) - A user can only access supplement recommendations associated with their pet.
     * @deny (create) - A user cannot create a supplement recommendation for a pet owned by another user.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/pets/{petId}/supplementRecommendations/{supplementRecommendationId} {
      // isOwner function check if the user id is the same as the authenticated user id
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // isExistingOwner checks if the user is the owner and the resource exists
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to activity records for pets.
     * @path /users/{userId}/pets/{petId}/activityRecords/{activityRecordId}
     * @allow (create) - A user can create an activity record for a pet they own.
     * @allow (get, list, update, delete) - A user can only access activity records associated with their pet.
     * @deny (create) - A user cannot create an activity record for a pet owned by another user.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/pets/{petId}/activityRecords/{activityRecordId} {
      // isOwner function check if the user id is the same as the authenticated user id
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // isExistingOwner checks if the user is the owner and the resource exists
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}